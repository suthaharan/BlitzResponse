<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blitz Response - Utility Dodge & Clear</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Cloud9 Branding */
            --c9-blue: #03A9F4;
            --c9-white: #FFFFFF;
            
            /* JetBrains Theme */
            --jb-background: #2B2B2B;
            --jb-text: #A9B7C6;
            --jb-accent: #4E9A06;
            
            /* VALORANT Colors (Generic) */
            --valorant-red: #FF4655;
            --valorant-black: #0F1923;
            --site-green: #1F8B4D;
            
            /* Game Colors */
            --enemy-red: #E74C3C;
            --friendly-blue: #3498DB;
            --success-green: #2ECC71;
            --warning-orange: #F39C12;
            
            /* Fonts */
            --font-heading: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --font-ui: 'Exo 2', sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--jb-background);
            color: var(--jb-text);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Background Themes */
        .bg-valorant-site {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .bg-valorant-site::before {
            content: '';
            position: absolute;
            top: 0;
            left: 30%;
            width: 2px;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }
        
        .bg-valorant-site::after {
            content: '';
            position: absolute;
            top: 0;
            right: 30%;
            width: 2px;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite 1s;
        }
        
        .bg-grid-tech {
            background: #0F1923;
            background-image: 
                linear-gradient(rgba(3, 169, 244, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(3, 169, 244, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            position: relative;
        }
        
        .bg-grid-tech::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(3, 169, 244, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(31, 139, 77, 0.1) 0%, transparent 50%);
        }
        
        .bg-neon-cyber {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #0a0a0a 100%);
            position: relative;
        }
        
        .bg-neon-cyber::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(3, 169, 244, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(255, 70, 85, 0.15) 0%, transparent 40%),
                linear-gradient(45deg, transparent 48%, rgba(3, 169, 244, 0.05) 49%, rgba(3, 169, 244, 0.05) 51%, transparent 52%);
            background-size: 100% 100%, 100% 100%, 20px 20px;
            animation: neonShift 10s ease-in-out infinite;
        }
        
        .bg-minimal-dark {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            position: relative;
        }
        
        .bg-minimal-dark::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(169, 183, 198, 0.1) 1px, transparent 0);
            background-size: 40px 40px;
        }
        
        .bg-geometric {
            background: #0F1923;
            position: relative;
            overflow: hidden;
        }
        
        .bg-geometric::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(3, 169, 244, 0.05) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(31, 139, 77, 0.05) 50%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .bg-geometric::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(3, 169, 244, 0.05) 0%, transparent 70%);
        }
        
        .bg-c9-arena {
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 50%, #001f3f 100%);
            position: relative;
        }
        
        .bg-c9-arena::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(3, 169, 244, 0.03) 2px, rgba(3, 169, 244, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(3, 169, 244, 0.03) 2px, rgba(3, 169, 244, 0.03) 4px);
            background-size: 100px 100px;
        }
        
        .bg-c9-arena::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 2px dashed rgba(3, 169, 244, 0.2);
            border-radius: 50%;
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes neonShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #gameCanvas {
            display: block;
            cursor: crosshair;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .ui-top {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .branding {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .c9-logo {
            font-family: var(--font-heading);
            font-weight: 900;
            font-size: 24px;
            color: var(--c9-blue);
            text-shadow: 0 0 10px var(--c9-blue);
        }
        
        .game-title {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 20px;
            color: var(--jb-text);
        }
        
        .score-display {
            font-family: var(--font-heading);
            font-size: 32px;
            font-weight: 700;
            color: var(--c9-blue);
            text-shadow: 0 0 10px var(--c9-blue);
        }
        
        .combo-display {
            font-family: var(--font-ui);
            font-size: 18px;
            color: var(--warning-orange);
            margin-top: 5px;
        }
        
        .timer-display {
            font-family: var(--font-heading);
            font-size: 24px;
            color: var(--jb-text);
            margin-top: 10px;
        }
        
        .ui-right {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        
        /* Menu Screens */
        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 25, 35, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: all;
        }
        
        .menu-screen#startMenu {
            background-image: url('assets/intro-background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .menu-screen#startMenu::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 25, 35, 0.75);
            z-index: 1;
        }
        
        .menu-screen#startMenu .menu-content {
            position: relative;
            z-index: 2;
        }
        
        .menu-screen.hidden {
            display: none;
        }
        
        .menu-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }
        
        .menu-title {
            font-family: var(--font-heading);
            font-size: 48px;
            font-weight: 900;
            color: var(--c9-blue);
            text-shadow: 0 0 20px var(--c9-blue);
            margin-bottom: 20px;
        }
        
        .menu-subtitle {
            font-family: var(--font-body);
            font-size: 20px;
            color: var(--jb-text);
            margin-bottom: 30px;
        }
        
        .instructions {
            background: rgba(43, 43, 43, 0.8);
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
            overflow: hidden;
        }
        
        .instructions-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.3s;
        }
        
        .instructions-header:hover {
            background: rgba(3, 169, 244, 0.1);
        }
        
        .instructions-header h3 {
            font-family: var(--font-heading);
            color: var(--c9-blue);
            margin: 0;
            font-size: 18px;
        }
        
        .instructions-toggle {
            color: var(--c9-blue);
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .instructions-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .instructions-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .instructions-content.expanded {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }
        
        .instructions-inner {
            padding: 0 20px 20px 20px;
        }
        
        .instructions ul {
            list-style: none;
            padding-left: 0;
            margin: 15px 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .instructions li::before {
            content: 'â–¶';
            position: absolute;
            left: 0;
            color: var(--c9-blue);
        }
        
        .btn {
            font-family: var(--font-ui);
            font-size: 18px;
            font-weight: 600;
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--c9-blue) 0%, #0288D1 100%);
            color: var(--c9-white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(3, 169, 244, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .leaderboard {
            background: rgba(43, 43, 43, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .leaderboard h3 {
            font-family: var(--font-heading);
            color: var(--c9-blue);
            margin-bottom: 15px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(169, 183, 198, 0.2);
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .achievement {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(3, 169, 244, 0.95);
            color: white;
            padding: 30px 50px;
            border-radius: 10px;
            font-family: var(--font-heading);
            font-size: 32px;
            z-index: 200;
            animation: achievementPop 2s forwards;
            pointer-events: none;
        }
        
        @keyframes achievementPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        .power-up-indicator {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(243, 156, 18, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: var(--font-ui);
            font-weight: 600;
            z-index: 50;
            animation: pulse 1s infinite;
        }
        
        .game-over-stats {
            margin: 20px 0;
            font-size: 18px;
        }
        
        .game-over-stats div {
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--jb-text);
            opacity: 0.7;
        }
        
        .stat-value {
            color: var(--c9-blue);
            font-weight: 700;
        }
        
        .player-info {
            font-family: var(--font-ui);
            font-size: 14px;
            color: var(--jb-text);
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .player-name {
            color: var(--c9-blue);
            font-weight: 600;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn-secondary {
            background: rgba(43, 43, 43, 0.8);
            border: 2px solid var(--c9-blue);
            color: var(--c9-blue);
        }
        
        .btn-secondary:hover {
            background: rgba(3, 169, 244, 0.2);
        }
        
        .btn-danger {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid var(--enemy-red);
            color: var(--enemy-red);
        }
        
        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.3);
        }
        
        .settings-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 25, 35, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            pointer-events: all;
        }
        
        .settings-menu.hidden {
            display: none;
        }
        
        .settings-content {
            background: rgba(43, 43, 43, 0.9);
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .settings-item {
            margin: 20px 0;
        }
        
        .settings-item label {
            display: block;
            margin-bottom: 10px;
            color: var(--jb-text);
            font-family: var(--font-ui);
        }
        
        .settings-item input {
            width: 100%;
            padding: 10px;
            background: rgba(43, 43, 43, 0.8);
            border: 2px solid var(--c9-blue);
            border-radius: 5px;
            color: var(--jb-text);
            font-family: var(--font-body);
            font-size: 16px;
        }
        
        .exit-confirmation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(11, 25, 35, 0.98);
            padding: 30px;
            border-radius: 10px;
            z-index: 200;
            text-align: center;
            border: 2px solid var(--c9-blue);
        }
        
        .exit-confirmation.hidden {
            display: none;
        }
        
        .exit-confirmation p {
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .exit-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .name-input-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(11, 25, 35, 0.98);
            padding: 30px;
            border-radius: 10px;
            z-index: 200;
            text-align: center;
            border: 2px solid var(--c9-blue);
            min-width: 300px;
        }
        
        .name-input-dialog.hidden {
            display: none;
        }
        
        .name-input-dialog input {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background: rgba(43, 43, 43, 0.8);
            border: 2px solid var(--c9-blue);
            border-radius: 5px;
            color: var(--jb-text);
            font-family: var(--font-body);
            font-size: 16px;
        }
        
        .name-input-dialog input:focus {
            outline: none;
            border-color: var(--c9-blue);
            box-shadow: 0 0 10px rgba(3, 169, 244, 0.5);
        }
        
        /* Video Modal */
        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .video-modal.hidden {
            display: none;
        }
        
        .video-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1;
        }
        
        .video-modal-content {
            position: relative;
            z-index: 2;
            max-width: 90%;
            max-height: 90%;
            width: 800px;
            background: var(--jb-background);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .video-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(43, 43, 43, 0.9);
            border: 2px solid var(--c9-blue);
            color: var(--c9-blue);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            z-index: 3;
            transition: all 0.3s;
        }
        
        .video-close-btn:hover {
            background: var(--c9-blue);
            color: white;
            transform: scale(1.1);
        }
        
        .video-modal-content video {
            width: 100%;
            height: auto;
            border-radius: 5px;
            display: block;
        }
        
        #introVideoLink:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="game-container bg-valorant-site" id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- UI Overlay -->
        <div class="ui-overlay">
            <div class="ui-top">
                <div class="branding">
                    <div class="c9-logo">C9</div>
                    <div class="game-title">Blitz Response</div>
                    <div class="player-info" id="playerInfo">
                        Player: <span class="player-name">Player</span>
                    </div>
                </div>
                <div class="ui-right">
                    <div class="score-display" id="scoreDisplay">0</div>
                    <div class="combo-display" id="comboDisplay"></div>
                    <div class="timer-display" id="timerDisplay">60</div>
                </div>
            </div>
        </div>
        
        <!-- Start Menu -->
        <div class="menu-screen" id="startMenu">
            <div class="menu-content">
                <h1 class="menu-title">Blitz Response</h1>
                <p class="menu-subtitle">Utility Dodge & Clear</p>
                
                <div class="instructions">
                    <div class="instructions-header" id="instructionsToggle">
                        <h3>How to Play</h3>
                        <span class="instructions-toggle" id="instructionsIcon">â–¼</span>
                    </div>
                    <div class="instructions-content" id="instructionsContent">
                        <div class="instructions-inner">
                            <ul>
                                <li>Click on <span style="color: var(--enemy-red);">enemy utilities</span> (red) to clear them</li>
                                <li>Avoid clicking <span style="color: var(--c9-blue);">friendly utilities</span> (blue)</li>
                                <li>Build combos for bonus points (see Combo Rules below)</li>
                                <li>Game duration is configurable in <strong>Settings</strong> (default: 60 seconds)</li>
                                <li>Survive as long as possible and aim for the highest score!</li>
                            </ul>
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(3, 169, 244, 0.1); border-left: 3px solid var(--c9-blue); border-radius: 5px;">
                                <h4 style="color: var(--c9-blue); margin-bottom: 10px; font-family: var(--font-heading);">Combo Rules:</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li><strong>Base Points:</strong> 10 points per correct clear</li>
                                    <li><strong>Combo Multiplier:</strong> Each consecutive correct clear increases your multiplier by 0.1x</li>
                                    <li><strong>Example:</strong> 
                                        <ul style="margin-top: 5px; padding-left: 20px; font-size: 13px;">
                                            <li>1st correct: 10 Ã— 1.0 = <strong>10 points</strong></li>
                                            <li>2nd correct: 10 Ã— 1.1 = <strong>11 points</strong> (combo 1)</li>
                                            <li>3rd correct: 10 Ã— 1.2 = <strong>12 points</strong> (combo 2)</li>
                                            <li>10th correct: 10 Ã— 2.0 = <strong>20 points</strong> (combo 9)</li>
                                            <li>40th correct: 10 Ã— 5.0 = <strong>50 points</strong> (max multiplier reached)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Combo Reset:</strong> Clicking a friendly utility resets your combo to 0 and multiplier back to 1.0x</li>
                                    <li><strong>Max Multiplier:</strong> 5.0x (reached at combo 40+)</li>
                                </ul>
                            </div>
                            
                            <p style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
                                ðŸ’¡ <strong>Tip:</strong> Build long combos to maximize your score! Avoid friendly utilities to keep your combo going.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn" id="startBtn">Start Game</button>
                    <button class="btn btn-secondary" id="newUserBtn">New User</button>
                    <button class="btn btn-secondary" id="settingsBtn">Settings</button>
                </div>
                
                <div class="leaderboard" id="startLeaderboard">
                    <h3>Top Scores</h3>
                    <div id="leaderboardList"></div>
                </div>
                
                <div style="margin-top: 20px; text-align: center; font-size: 12px; opacity: 0.6;">
                    <a href="#" id="creditsLink" style="color: var(--jb-text); text-decoration: none;">Credits & Attribution</a>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <a href="#" id="introVideoLink" style="color: var(--c9-blue); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: opacity 0.3s;">
                        <i class="fas fa-play-circle"></i> Watch Intro Video
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Video Player Modal -->
        <div class="video-modal hidden" id="videoModal">
            <div class="video-modal-overlay" id="videoModalOverlay"></div>
            <div class="video-modal-content">
                <button class="video-close-btn" id="videoCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
                <video id="introVideo" controls>
                    <source src="assets/blitzresponse-intro.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        
        <!-- Game Over Menu -->
        <div class="menu-screen hidden" id="gameOverMenu">
            <div class="menu-content">
                <h1 class="menu-title">Game Over</h1>
                
                <div class="game-over-stats">
                    <div>
                        <span class="stat-label">Final Score: </span>
                        <span class="stat-value" id="finalScore">0</span>
                    </div>
                    <div>
                        <span class="stat-label">Max Combo: </span>
                        <span class="stat-value" id="maxCombo">0</span>
                    </div>
                    <div>
                        <span class="stat-label">Enemies Cleared: </span>
                        <span class="stat-value" id="enemiesCleared">0</span>
                    </div>
                    <div id="newHighScore" style="display: none; color: var(--success-green); margin-top: 15px; font-weight: 700;">
                        ðŸŽ‰ New High Score! ðŸŽ‰
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn" id="playAgainBtn">Play Again</button>
                    <button class="btn btn-secondary" id="exitBtn">Exit</button>
                </div>
                
                <div class="leaderboard" id="gameOverLeaderboard">
                    <h3>Top Scores</h3>
                    <div id="gameOverLeaderboardList"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Menu -->
        <div class="settings-menu hidden" id="settingsMenu">
            <div class="settings-content">
                <h2 class="menu-title" style="margin-bottom: 30px;">Settings</h2>
                
                <div class="settings-item">
                    <label for="gameDuration">Game Duration (seconds):</label>
                    <input type="number" id="gameDuration" min="30" max="180" value="60">
                </div>
                
                <div class="settings-item">
                    <label for="backgroundTheme">Background Theme:</label>
                    <select id="backgroundTheme" style="width: 100%; padding: 10px; background: rgba(43, 43, 43, 0.8); border: 2px solid var(--c9-blue); border-radius: 5px; color: var(--jb-text); font-family: var(--font-body); font-size: 16px;">
                        <option value="bg-valorant-site">VALORANT Site (Default)</option>
                        <option value="bg-grid-tech">Grid Tech</option>
                        <option value="bg-neon-cyber">Neon Cyber</option>
                        <option value="bg-minimal-dark">Minimal Dark</option>
                        <option value="bg-geometric">Geometric Pattern</option>
                        <option value="bg-c9-arena">C9 Arena</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <label>Sound Test:</label>
                    <button class="btn btn-secondary" id="testSoundBtn" style="width: 100%; margin-top: 5px;">Test Sound</button>
                    <small style="display: block; margin-top: 5px; opacity: 0.7;">Click to test if sounds are working</small>
                </div>
                
                <div class="btn-group" style="margin-top: 30px;">
                    <button class="btn" id="restartGameBtn">Restart Game</button>
                    <button class="btn btn-danger" id="clearPlayersBtn">Clear Players</button>
                    <button class="btn btn-secondary" id="showCreditsBtn">Credits</button>
                    <button class="btn btn-secondary" id="closeSettingsBtn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Credits Menu -->
        <div class="settings-menu hidden" id="creditsMenu">
            <div class="settings-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <h2 class="menu-title" style="margin-bottom: 30px;">Credits & Attribution</h2>
                
                <div style="text-align: left; line-height: 1.8;">
                    <h3 style="color: var(--c9-blue); margin-top: 20px; margin-bottom: 10px;">Sound Effects</h3>
                    <p>All sound effects are sourced from <strong>Freesound.org</strong> under Creative Commons licenses.</p>
                    <p><strong>Source:</strong> <a href="https://freesound.org" target="_blank" style="color: var(--c9-blue);">https://freesound.org</a></p>
                    <p><strong>License:</strong> Creative Commons (CC0 or CC BY)</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>correct.mp3 - Positive feedback sound</li>
                        <li>wrong.mp3 - Error sound for friendly fire</li>
                        <li>combo.mp3 - Combo multiplier sound</li>
                        <li>start.mp3 - Game start sound</li>
                        <li>stop.mp3 - Game over sound</li>
                    </ul>
                    
                    <h3 style="color: var(--c9-blue); margin-top: 30px; margin-bottom: 10px;">Icons</h3>
                    <p><strong>Font Awesome</strong> - Icons loaded via CDN</p>
                    <p><strong>Source:</strong> <a href="https://fontawesome.com" target="_blank" style="color: var(--c9-blue);">https://fontawesome.com</a></p>
                    <p><strong>License:</strong> Font Awesome Free License</p>
                    
                    <h3 style="color: var(--c9-blue); margin-top: 30px; margin-bottom: 10px;">Fonts</h3>
                    <p><strong>Google Fonts</strong> - Open Font License (OFL)</p>
                    <p><strong>Source:</strong> <a href="https://fonts.google.com" target="_blank" style="color: var(--c9-blue);">https://fonts.google.com</a></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Orbitron (Headings)</li>
                        <li>Rajdhani (Body text)</li>
                        <li>Exo 2 (UI elements)</li>
                    </ul>
                    
                    <h3 style="color: var(--c9-blue); margin-top: 30px; margin-bottom: 10px;">Original Work</h3>
                    <p>The following are original creations:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Game code and logic</li>
                        <li>Game design and mechanics</li>
                        <li>UI/UX design</li>
                        <li>Canvas rendering system</li>
                    </ul>
                    
                    <div style="margin-top: 30px; padding: 15px; background: rgba(3, 169, 244, 0.1); border-left: 3px solid var(--c9-blue); border-radius: 5px;">
                        <p style="margin: 0;"><strong>Note:</strong> All assets used are under Creative Commons or open licenses. See CREDITS.txt file for complete attribution details.</p>
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 30px;">
                    <button class="btn btn-secondary" id="closeCreditsBtn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Name Input Dialog -->
        <div class="name-input-dialog hidden" id="nameInputDialog">
            <h3 style="color: var(--c9-blue); margin-bottom: 10px;">Enter Your Name</h3>
            <input type="text" id="playerNameInput" placeholder="Player Name" maxlength="20" autofocus>
            <div class="btn-group">
                <button class="btn" id="confirmNameBtn">Confirm</button>
                <button class="btn btn-secondary" id="cancelNameBtn">Cancel</button>
            </div>
        </div>
        
        <!-- Exit Confirmation -->
        <div class="exit-confirmation hidden" id="exitConfirmation">
            <p>Are you sure you want to exit the game?</p>
            <div class="exit-buttons">
                <button class="btn btn-danger" id="confirmExitBtn">Yes, Exit</button>
                <button class="btn btn-secondary" id="cancelExitBtn">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // Game Configuration
        const CONFIG = {
            GAME_DURATION: 60, // seconds (configurable)
            BASE_POINTS: 10,
            FRIENDLY_FIRE_PENALTY: 5,
            COMBO_MULTIPLIER_INCREMENT: 0.1,
            MAX_COMBO_MULTIPLIER: 5.0,
            DIFFICULTY_INTERVAL: 15, // seconds
            DIFFICULTY_INCREMENT: 0.5,
            SPAWN_RATE_BASE: 1.0, // utilities per second
            ENEMY_RATIO: 0.7, // 70% enemy, 30% friendly
            MAX_UTILITIES: 25,
            UTILITY_SIZE: 60,
            UTILITY_LIFETIME: 5 // seconds
        };
        
        // Load game duration from localStorage
        function loadGameDuration() {
            try {
                const saved = localStorage.getItem('blitzResponseGameDuration');
                if (saved) {
                    const duration = parseInt(saved, 10);
                    if (duration >= 30 && duration <= 180) {
                        CONFIG.GAME_DURATION = duration;
                    }
                }
            } catch (e) {
                console.error('Failed to load game duration:', e);
            }
        }
        
        // Save game duration to localStorage
        function saveGameDuration(duration) {
            try {
                localStorage.setItem('blitzResponseGameDuration', duration.toString());
                CONFIG.GAME_DURATION = duration;
            } catch (e) {
                console.error('Failed to save game duration:', e);
            }
        }
        
        // Load background theme from localStorage
        function loadBackgroundTheme() {
            try {
                const stored = localStorage.getItem('blitzResponseBackgroundTheme');
                if (stored) {
                    return stored;
                }
            } catch (e) {
                console.error('Failed to load background theme:', e);
            }
            return 'bg-valorant-site'; // Default
        }
        
        // Save background theme to localStorage
        function saveBackgroundTheme(theme) {
            try {
                localStorage.setItem('blitzResponseBackgroundTheme', theme);
            } catch (e) {
                console.error('Failed to save background theme:', e);
            }
        }
        
        // Apply background theme
        function applyBackgroundTheme(theme) {
            const container = document.getElementById('gameContainer');
            if (container) {
                // Remove all background classes
                container.className = container.className.replace(/bg-\w+/g, '');
                // Add new background class
                container.classList.add('game-container', theme);
            }
        }
        
        // Initialize
        loadGameDuration();
        const initialTheme = loadBackgroundTheme();
        applyBackgroundTheme(initialTheme);
        
        // Asset Icons
        const UTILITY_ICONS = {
            smoke: '<i class="fas fa-smog"></i>',
            molly: '<i class="fas fa-fire"></i>',
            flash: '<i class="fas fa-bolt"></i>',
            trip: '<i class="fas fa-eye-slash"></i>',
            friendly: '<i class="fas fa-shield-alt"></i>'
        };
        
        // Sound Manager
        class SoundManager {
            constructor() {
                this.sounds = {};
                this.enabled = true;
                this.volume = 0.3;
                this.audioUnlocked = false;
                this.loadSounds();
                this.setupAudioUnlock();
            }
            
            loadSounds() {
                const soundFiles = {
                    correct: 'assets/sounds/correct.mp3',
                    wrong: 'assets/sounds/wrong.mp3',
                    combo: 'assets/sounds/combo.mp3',
                    start: 'assets/sounds/start.mp3',
                    stop: 'assets/sounds/stop.mp3'
                };
                
                Object.keys(soundFiles).forEach(key => {
                    const audio = new Audio(soundFiles[key]);
                    audio.volume = this.volume;
                    audio.preload = 'auto';
                    
                    // Handle loading errors
                    audio.addEventListener('error', (e) => {
                        console.warn(`Sound file error for ${key}:`, soundFiles[key], e);
                    });
                    
                    // Handle successful loading
                    audio.addEventListener('canplaythrough', () => {
                        console.log(`Sound loaded: ${key}`);
                    });
                    
                    this.sounds[key] = audio;
                });
            }
            
            setupAudioUnlock() {
                // Unlock audio on first user interaction
                const unlockAudio = () => {
                    if (!this.audioUnlocked) {
                        // Try to play a silent sound to unlock audio context
                        const unlockSound = this.sounds['correct'] || this.sounds['start'];
                        if (unlockSound) {
                            unlockSound.play().then(() => {
                                unlockSound.pause();
                                unlockSound.currentTime = 0;
                                this.audioUnlocked = true;
                                console.log('Audio unlocked');
                            }).catch(err => {
                                console.warn('Audio unlock failed:', err);
                            });
                        }
                    }
                };
                
                // Unlock on any user interaction
                document.addEventListener('click', unlockAudio, { once: true });
                document.addEventListener('touchstart', unlockAudio, { once: true });
                document.addEventListener('keydown', unlockAudio, { once: true });
            }
            
            play(soundName) {
                if (!this.enabled) {
                    console.log('Sounds disabled');
                    return;
                }
                
                const sound = this.sounds[soundName];
                if (!sound) {
                    console.warn(`Sound not found: ${soundName}`);
                    return;
                }
                
                try {
                    // Reset to start
                    sound.currentTime = 0;
                    
                    // Play the sound
                    const playPromise = sound.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log(`Playing sound: ${soundName}`);
                        }).catch(error => {
                            // Autoplay was prevented - try to unlock
                            console.warn(`Sound play prevented for ${soundName}:`, error);
                            if (!this.audioUnlocked) {
                                this.setupAudioUnlock();
                            }
                        });
                    }
                } catch (e) {
                    console.error(`Error playing sound ${soundName}:`, e);
                }
            }
        }
        
        // Player Manager
        class PlayerManager {
            constructor() {
                this.storageKey = 'blitzResponseCurrentPlayer';
                this.playersKey = 'blitzResponsePlayers';
                this.currentPlayer = this.loadCurrentPlayer();
            }
            
            loadCurrentPlayer() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    return saved || null;
                } catch (e) {
                    console.error('Failed to load current player:', e);
                    return null;
                }
            }
            
            saveCurrentPlayer(playerName) {
                try {
                    localStorage.setItem(this.storageKey, playerName);
                    this.currentPlayer = playerName;
                    
                    // Also save to players list
                    const players = this.getAllPlayers();
                    if (!players.includes(playerName)) {
                        players.push(playerName);
                        localStorage.setItem(this.playersKey, JSON.stringify(players));
                    }
                } catch (e) {
                    console.error('Failed to save current player:', e);
                }
            }
            
            getAllPlayers() {
                try {
                    const saved = localStorage.getItem(this.playersKey);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            }
            
            clearAllPlayers() {
                try {
                    localStorage.removeItem(this.storageKey);
                    localStorage.removeItem(this.playersKey);
                    this.currentPlayer = null;
                } catch (e) {
                    console.error('Failed to clear players:', e);
                }
            }
            
            getCurrentPlayer() {
                return this.currentPlayer || 'Player';
            }
        }
        
        // Game State
        class GameState {
            constructor() {
                this.score = 0;
                this.combo = 0;
                this.multiplier = 1.0;
                this.timer = CONFIG.GAME_DURATION;
                this.difficulty = 1.0;
                this.isGameOver = false;
                this.gameStartTime = 0;
                this.enemiesCleared = 0;
                this.maxCombo = 0;
                this.mistakes = 0;
                this.powerUps = {
                    doubleScore: false,
                    freezeTime: false,
                    clearAll: false
                };
                this.powerUpEndTime = 0;
            }
            
            update(deltaTime) {
                if (this.isGameOver) return;
                
                // Update timer (unless frozen)
                if (!this.powerUps.freezeTime) {
                    this.timer -= deltaTime;
                }
                
                // Update difficulty every 15 seconds
                const elapsed = (Date.now() - this.gameStartTime) / 1000;
                this.difficulty = 1.0 + Math.floor(elapsed / CONFIG.DIFFICULTY_INTERVAL) * CONFIG.DIFFICULTY_INCREMENT;
                
                // Check power-up expiration
                if (this.powerUpEndTime > 0 && Date.now() > this.powerUpEndTime) {
                    this.powerUps = {
                        doubleScore: false,
                        freezeTime: false,
                        clearAll: false
                    };
                    this.powerUpEndTime = 0;
                }
                
                if (this.timer <= 0) {
                    this.timer = 0;
                    this.isGameOver = true;
                }
            }
            
            addScore(points) {
                const finalPoints = this.powerUps.doubleScore ? points * 2 : points;
                this.score += Math.floor(finalPoints);
            }
            
            increaseCombo() {
                this.combo++;
                this.maxCombo = Math.max(this.maxCombo, this.combo);
                this.multiplier = Math.min(
                    CONFIG.MAX_COMBO_MULTIPLIER,
                    1.0 + (this.combo * CONFIG.COMBO_MULTIPLIER_INCREMENT)
                );
            }
            
            resetCombo() {
                this.combo = 0;
                this.multiplier = 1.0;
            }
        }
        
        // Utility Class
        class Utility {
            constructor(type, isEnemy, position) {
                this.type = type;
                this.isEnemy = isEnemy;
                this.position = position;
                this.size = CONFIG.UTILITY_SIZE;
                this.baseSize = CONFIG.UTILITY_SIZE;
                this.rotation = 0;
                this.animationFrame = 0;
                this.lifetime = 0;
                this.maxLifetime = CONFIG.UTILITY_LIFETIME;
                this.id = Math.random().toString(36).substr(2, 9);
            }
            
            update(deltaTime) {
                this.lifetime += deltaTime;
                this.animationFrame += deltaTime * 5;
                this.rotation += deltaTime * 30; // degrees per second
                
                // Pulsing effect
                this.size = this.baseSize * (1 + Math.sin(this.animationFrame) * 0.15);
            }
            
            isPointInside(x, y) {
                const dx = x - this.position.x;
                const dy = y - this.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= this.size / 2;
            }
            
            render(ctx) {
                const alpha = 1 - (this.lifetime / this.maxLifetime);
                if (alpha <= 0) return;
                
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate((this.rotation * Math.PI) / 180);
                
                // Draw circle background
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size / 2);
                
                if (this.isEnemy) {
                    gradient.addColorStop(0, `rgba(231, 76, 60, ${alpha})`);
                    gradient.addColorStop(1, `rgba(192, 57, 43, ${alpha})`);
                } else {
                    gradient.addColorStop(0, `rgba(52, 152, 219, ${alpha})`);
                    gradient.addColorStop(1, `rgba(41, 128, 185, ${alpha})`);
                }
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw border
                ctx.strokeStyle = this.isEnemy ? `rgba(231, 76, 60, ${alpha})` : `rgba(3, 169, 244, ${alpha})`;
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw icon (simplified - using text/emoji as fallback)
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.font = `${this.size * 0.4}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const iconMap = {
                    smoke: 'â˜',
                    molly: 'ðŸ”¥',
                    flash: 'âš¡',
                    trip: 'âš ',
                    friendly: 'ðŸ›¡'
                };
                
                ctx.fillText(iconMap[this.type] || '?', 0, 0);
                
                ctx.restore();
            }
        }
        
        // Utility Spawner
        class UtilitySpawner {
            constructor(canvas) {
                this.canvas = canvas;
                this.activeUtilities = [];
                this.timeSinceLastSpawn = 0;
            }
            
            update(deltaTime, difficulty) {
                // Update all utilities
                this.activeUtilities.forEach(utility => utility.update(deltaTime));
                
                // Remove expired utilities
                this.activeUtilities = this.activeUtilities.filter(
                    utility => utility.lifetime < utility.maxLifetime
                );
                
                // Spawn new utilities
                const spawnRate = CONFIG.SPAWN_RATE_BASE * difficulty;
                const spawnInterval = 1 / spawnRate;
                this.timeSinceLastSpawn += deltaTime;
                
                if (this.timeSinceLastSpawn >= spawnInterval && this.activeUtilities.length < CONFIG.MAX_UTILITIES) {
                    this.spawnUtility();
                    this.timeSinceLastSpawn = 0;
                }
            }
            
            spawnUtility() {
                const isEnemy = Math.random() < CONFIG.ENEMY_RATIO;
                const types = ['smoke', 'molly', 'flash', 'trip'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                const margin = CONFIG.UTILITY_SIZE;
                const position = {
                    x: margin + Math.random() * (this.canvas.width - margin * 2),
                    y: margin + Math.random() * (this.canvas.height - margin * 2)
                };
                
                const utility = new Utility(type, isEnemy, position);
                this.activeUtilities.push(utility);
            }
            
            removeUtility(utility) {
                const index = this.activeUtilities.indexOf(utility);
                if (index > -1) {
                    this.activeUtilities.splice(index, 1);
                }
            }
            
            clearAll() {
                this.activeUtilities = [];
            }
        }
        
        // Collision Detector
        class CollisionDetector {
            findUtilityAt(x, y, utilities) {
                // Check in reverse order (top-most first)
                for (let i = utilities.length - 1; i >= 0; i--) {
                    if (utilities[i].isPointInside(x, y)) {
                        return utilities[i];
                    }
                }
                return null;
            }
        }
        
        // Leaderboard Manager
        class LeaderboardManager {
            constructor() {
                this.storageKey = 'blitzResponseLeaderboard';
                this.maxEntries = 10;
            }
            
            loadLeaderboard() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (e) {
                    return [];
                }
            }
            
            clearLeaderboard() {
                try {
                    localStorage.removeItem(this.storageKey);
                } catch (e) {
                    console.error('Failed to clear leaderboard:', e);
                }
            }
            
            saveScore(score, playerName = 'Player') {
                const leaderboard = this.loadLeaderboard();
                const entry = {
                    score: score,
                    playerName: playerName,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                leaderboard.push(entry);
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard.splice(this.maxEntries);
                
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(leaderboard));
                } catch (e) {
                    console.error('Failed to save leaderboard:', e);
                }
                
                return leaderboard;
            }
            
            isHighScore(score) {
                const leaderboard = this.loadLeaderboard();
                if (leaderboard.length < this.maxEntries) return true;
                return score > leaderboard[leaderboard.length - 1].score;
            }
        }
        
        // Achievement Manager
        class AchievementManager {
            checkAchievements(gameState) {
                const achievements = [];
                
                // C9 Pro: 50+ combo
                if (gameState.maxCombo >= 50) {
                    achievements.push({
                        name: 'C9 Pro',
                        description: 'Achieved 50+ combo!'
                    });
                }
                
                // Perfect Retake: No mistakes
                if (gameState.mistakes === 0 && gameState.enemiesCleared > 0) {
                    achievements.push({
                        name: 'Perfect Retake',
                        description: 'No mistakes!'
                    });
                }
                
                return achievements;
            }
            
            showAchievement(achievement) {
                const div = document.createElement('div');
                div.className = 'achievement';
                div.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">ðŸ†</div>
                    <div>${achievement.name}</div>
                    <div style="font-size: 18px; margin-top: 5px;">${achievement.description}</div>
                `;
                document.body.appendChild(div);
                
                setTimeout(() => {
                    div.remove();
                }, 2000);
            }
        }
        
        // Main Game Class
        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.state = new GameState();
                this.spawner = new UtilitySpawner(this.canvas);
                this.collisionDetector = new CollisionDetector();
                this.leaderboardManager = new LeaderboardManager();
                this.achievementManager = new AchievementManager();
                this.soundManager = new SoundManager();
                this.playerManager = new PlayerManager();
                this.isRunning = false;
                this.lastFrameTime = 0;
                this.particles = [];
                
                this.setupCanvas();
                this.setupEventListeners();
                this.updateUI();
                this.updateLeaderboard();
            }
            
            setupCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            }
            
            setupEventListeners() {
                this.canvas.addEventListener('click', (e) => {
                    if (!this.isRunning) {
                        return;
                    }
                    
                    if (this.state.isGameOver) {
                        return;
                    }
                    
                    const rect = this.canvas.getBoundingClientRect();
                    // Calculate click position accounting for canvas scaling
                    const scaleX = this.canvas.width / rect.width;
                    const scaleY = this.canvas.height / rect.height;
                    const x = (e.clientX - rect.left) * scaleX;
                    const y = (e.clientY - rect.top) * scaleY;
                    
                    this.handleClick(x, y);
                });
                
                // Start game button
                document.getElementById('startBtn').addEventListener('click', () => {
                    if (!this.playerManager.currentPlayer) {
                        this.showNameInput(() => this.startGame());
                    } else {
                        this.startGame();
                    }
                });
                
                // Play again button
                document.getElementById('playAgainBtn').addEventListener('click', () => {
                    this.startGame();
                });
                
                // When start menu becomes visible, refresh dashboard
                const startMenu = document.getElementById('startMenu');
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (!startMenu.classList.contains('hidden')) {
                                this.refreshDashboard();
                            }
                        }
                    });
                });
                observer.observe(startMenu, { attributes: true });
                
                // New user button
                document.getElementById('newUserBtn').addEventListener('click', () => {
                    this.showNameInput((name) => {
                        this.playerManager.saveCurrentPlayer(name);
                        this.updateUI();
                    });
                });
                
                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showSettings();
                });
                
                // Close settings
                document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                    this.hideSettings();
                });
                
                // Show credits
                document.getElementById('showCreditsBtn').addEventListener('click', () => {
                    this.showCredits();
                });
                
                // Credits link in start menu
                document.getElementById('creditsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('startMenu').classList.add('hidden');
                    this.showCredits();
                });
                
                // Intro video link
                document.getElementById('introVideoLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showIntroVideo();
                });
                
                // Video modal close
                document.getElementById('videoCloseBtn').addEventListener('click', () => {
                    this.hideIntroVideo();
                });
                
                document.getElementById('videoModalOverlay').addEventListener('click', () => {
                    this.hideIntroVideo();
                });
                
                // Instructions accordion toggle
                document.getElementById('instructionsToggle').addEventListener('click', () => {
                    this.toggleInstructions();
                });
                
                // Close credits
                document.getElementById('closeCreditsBtn').addEventListener('click', () => {
                    this.hideCredits();
                });
                
                // Restart game
                document.getElementById('restartGameBtn').addEventListener('click', () => {
                    if (confirm('Restart the game? Current progress will be lost.')) {
                        this.restartGame();
                    }
                });
                
                // Clear players
                document.getElementById('clearPlayersBtn').addEventListener('click', () => {
                    if (confirm('Clear all player data? This cannot be undone.')) {
                        this.playerManager.clearAllPlayers();
                        this.leaderboardManager.clearLeaderboard();
                        this.updateUI();
                        this.updateLeaderboard();
                        this.updateLeaderboard('gameOverLeaderboardList');
                        alert('All player data cleared.');
                    }
                });
                
                // Exit button
                document.getElementById('exitBtn').addEventListener('click', () => {
                    this.showExitConfirmation();
                });
                
                // Exit confirmation
                document.getElementById('confirmExitBtn').addEventListener('click', () => {
                    this.exitGame();
                });
                
                document.getElementById('cancelExitBtn').addEventListener('click', () => {
                    this.hideExitConfirmation();
                });
                
                // Name input
                document.getElementById('confirmNameBtn').addEventListener('click', () => {
                    const name = document.getElementById('playerNameInput').value.trim();
                    if (name) {
                        this.playerManager.saveCurrentPlayer(name);
                        this.hideNameInput();
                        this.updateUI();
                        if (this.nameInputCallback) {
                            this.nameInputCallback(name);
                            this.nameInputCallback = null;
                        }
                    }
                });
                
                document.getElementById('cancelNameBtn').addEventListener('click', () => {
                    this.hideNameInput();
                });
                
                // Enter key in name input
                document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('confirmNameBtn').click();
                    }
                });
                
                // Game duration input
                document.getElementById('gameDuration').addEventListener('change', (e) => {
                    const duration = parseInt(e.target.value, 10);
                    if (duration >= 30 && duration <= 180) {
                        saveGameDuration(duration);
                    }
                });
                
                // Background theme selector
                document.getElementById('backgroundTheme').addEventListener('change', (e) => {
                    this.changeBackgroundTheme(e.target.value);
                });
                
                // Test sound button
                document.getElementById('testSoundBtn').addEventListener('click', () => {
                    this.testSound();
                });
                
                // Power-up keys (for testing, can be removed)
                document.addEventListener('keydown', (e) => {
                    if (!this.isRunning) return;
                    
                    if (e.key === '1') this.activatePowerUp('doubleScore');
                    if (e.key === '2') this.activatePowerUp('freezeTime');
                    if (e.key === '3') this.activatePowerUp('clearAll');
                });
            }
            
            startGame() {
                // Reload game duration in case it changed
                loadGameDuration();
                
                this.state = new GameState();
                this.spawner.clearAll();
                this.state.gameStartTime = Date.now();
                this.isRunning = true;
                
                document.getElementById('startMenu').classList.add('hidden');
                document.getElementById('gameOverMenu').classList.add('hidden');
                document.getElementById('settingsMenu').classList.add('hidden');
                
                // Ensure audio is unlocked before playing
                if (!this.soundManager.audioUnlocked) {
                    // Try to unlock audio by playing a test sound
                    const testSound = this.soundManager.sounds['start'];
                    if (testSound) {
                        testSound.play().then(() => {
                            testSound.pause();
                            testSound.currentTime = 0;
                            this.soundManager.audioUnlocked = true;
                            this.soundManager.play('start');
                        }).catch(() => {
                            // If unlock fails, still try to play
                            this.soundManager.play('start');
                        });
                    } else {
                        this.soundManager.play('start');
                    }
                } else {
                    this.soundManager.play('start');
                }
                
                this.lastFrameTime = performance.now();
                this.gameLoop();
            }
            
            restartGame() {
                this.isRunning = false;
                this.state = new GameState();
                this.spawner.clearAll();
                this.particles = [];
                
                document.getElementById('startMenu').classList.remove('hidden');
                document.getElementById('gameOverMenu').classList.add('hidden');
                document.getElementById('settingsMenu').classList.add('hidden');
                
                this.refreshDashboard();
            }
            
            exitGame() {
                this.isRunning = false;
                this.hideExitConfirmation();
                document.getElementById('gameOverMenu').classList.add('hidden');
                document.getElementById('startMenu').classList.remove('hidden');
                this.refreshDashboard();
            }
            
            refreshDashboard() {
                // Update player info
                this.updateUI();
                
                // Update leaderboard
                this.updateLeaderboard();
                
                // Update game duration display in instructions if needed
                this.updateDashboardContent();
            }
            
            updateDashboardContent() {
                // Update any dynamic content on dashboard
                // This ensures the dashboard shows current settings
                const duration = CONFIG.GAME_DURATION;
                // The instructions already mention it's configurable, so no need to update
            }
            
            showNameInput(callback) {
                this.nameInputCallback = callback;
                document.getElementById('nameInputDialog').classList.remove('hidden');
                document.getElementById('playerNameInput').value = '';
                document.getElementById('playerNameInput').focus();
            }
            
            hideNameInput() {
                document.getElementById('nameInputDialog').classList.add('hidden');
            }
            
            showSettings() {
                document.getElementById('gameDuration').value = CONFIG.GAME_DURATION;
                document.getElementById('backgroundTheme').value = loadBackgroundTheme();
                document.getElementById('settingsMenu').classList.remove('hidden');
            }
            
            changeBackgroundTheme(theme) {
                applyBackgroundTheme(theme);
                saveBackgroundTheme(theme);
            }
            
            testSound() {
                // Test sound playback
                const testBtn = document.getElementById('testSoundBtn');
                const originalText = testBtn.textContent;
                testBtn.textContent = 'Playing...';
                testBtn.disabled = true;
                
                // Try to unlock audio first
                if (!this.soundManager.audioUnlocked) {
                    const testSound = this.soundManager.sounds['correct'];
                    if (testSound) {
                        testSound.play().then(() => {
                            testSound.pause();
                            testSound.currentTime = 0;
                            this.soundManager.audioUnlocked = true;
                            this.soundManager.play('correct');
                            setTimeout(() => {
                                testBtn.textContent = 'âœ“ Sound Working!';
                                setTimeout(() => {
                                    testBtn.textContent = originalText;
                                    testBtn.disabled = false;
                                }, 2000);
                            }, 500);
                        }).catch(err => {
                            testBtn.textContent = 'âœ— Audio Blocked';
                            console.error('Sound test failed:', err);
                            setTimeout(() => {
                                testBtn.textContent = originalText;
                                testBtn.disabled = false;
                            }, 2000);
                        });
                    }
                } else {
                    this.soundManager.play('correct');
                    setTimeout(() => {
                        testBtn.textContent = 'âœ“ Sound Working!';
                        setTimeout(() => {
                            testBtn.textContent = originalText;
                            testBtn.disabled = false;
                        }, 2000);
                    }, 500);
                }
            }
            
            changeBackgroundTheme(theme) {
                applyBackgroundTheme(theme);
                saveBackgroundTheme(theme);
            }
            
            hideSettings() {
                document.getElementById('settingsMenu').classList.add('hidden');
                // Refresh dashboard when closing settings
                this.refreshDashboard();
            }
            
            showCredits() {
                document.getElementById('creditsMenu').classList.remove('hidden');
            }
            
            hideCredits() {
                document.getElementById('creditsMenu').classList.add('hidden');
                // Return to start menu if we came from there
                if (document.getElementById('startMenu').classList.contains('hidden') && !this.isRunning) {
                    document.getElementById('startMenu').classList.remove('hidden');
                }
            }
            
            toggleInstructions() {
                const content = document.getElementById('instructionsContent');
                const icon = document.getElementById('instructionsIcon');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            }
            
            showIntroVideo() {
                const modal = document.getElementById('videoModal');
                const video = document.getElementById('introVideo');
                modal.classList.remove('hidden');
                video.play().catch(err => {
                    console.log('Video autoplay prevented:', err);
                });
            }
            
            hideIntroVideo() {
                const modal = document.getElementById('videoModal');
                const video = document.getElementById('introVideo');
                video.pause();
                video.currentTime = 0;
                modal.classList.add('hidden');
            }
            
            showExitConfirmation() {
                document.getElementById('exitConfirmation').classList.remove('hidden');
            }
            
            hideExitConfirmation() {
                document.getElementById('exitConfirmation').classList.add('hidden');
            }
            
            handleClick(x, y) {
                const utility = this.collisionDetector.findUtilityAt(
                    x, y,
                    this.spawner.activeUtilities
                );
                
                if (!utility) return;
                
                if (utility.isEnemy) {
                    // Correct clear
                    const points = Math.floor(CONFIG.BASE_POINTS * this.state.multiplier);
                    this.state.addScore(points);
                    this.state.increaseCombo();
                    this.state.enemiesCleared++;
                    
                    // Play sound
                    if (this.state.combo > 1) {
                        this.soundManager.play('combo');
                    } else {
                        this.soundManager.play('correct');
                    }
                    
                    // Check for achievements
                    const achievements = this.achievementManager.checkAchievements(this.state);
                    achievements.forEach(ach => {
                        if (!this.state.achievementsShown) {
                            this.achievementManager.showAchievement(ach);
                        }
                    });
                    this.state.achievementsShown = true;
                    
                } else {
                    // Friendly fire
                    this.state.score = Math.max(0, this.state.score - CONFIG.FRIENDLY_FIRE_PENALTY);
                    this.state.resetCombo();
                    this.state.mistakes++;
                    this.soundManager.play('wrong');
                }
                
                this.spawner.removeUtility(utility);
                this.createParticles(utility.position, utility.isEnemy);
            }
            
            activatePowerUp(type) {
                this.state.powerUps[type] = true;
                this.state.powerUpEndTime = Date.now() + 5000; // 5 seconds
                
                if (type === 'clearAll') {
                    this.spawner.clearAll();
                }
            }
            
            createParticles(position, isEnemy) {
                for (let i = 0; i < 10; i++) {
                    this.particles.push({
                        x: position.x,
                        y: position.y,
                        vx: (Math.random() - 0.5) * 200,
                        vy: (Math.random() - 0.5) * 200,
                        life: 1.0,
                        color: isEnemy ? '#E74C3C' : '#03A9F4'
                    });
                }
            }
            
            updateParticles(deltaTime) {
                this.particles = this.particles.filter(particle => {
                    particle.x += particle.vx * deltaTime;
                    particle.y += particle.vy * deltaTime;
                    particle.life -= deltaTime * 2;
                    return particle.life > 0;
                });
            }
            
            renderParticles() {
                this.particles.forEach(particle => {
                    this.ctx.save();
                    this.ctx.globalAlpha = particle.life;
                    this.ctx.fillStyle = particle.color;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.restore();
                });
            }
            
            gameLoop() {
                if (!this.isRunning) return;
                
                const currentTime = performance.now();
                const deltaTime = Math.min((currentTime - this.lastFrameTime) / 1000, 0.1);
                this.lastFrameTime = currentTime;
                
                // Update
                this.state.update(deltaTime);
                this.spawner.update(deltaTime, this.state.difficulty);
                this.updateParticles(deltaTime);
                
                // Render
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw utilities
                this.spawner.activeUtilities.forEach(utility => utility.render(this.ctx));
                
                // Draw particles
                this.renderParticles();
                
                // Update UI
                this.updateUI();
                
                // Check game over
                if (this.state.isGameOver) {
                    this.endGame();
                } else {
                    requestAnimationFrame(() => this.gameLoop());
                }
            }
            
            updateUI() {
                // Update player info (always update, even when not in game)
                const playerInfo = document.getElementById('playerInfo');
                if (playerInfo) {
                    playerInfo.innerHTML = `Player: <span class="player-name">${this.playerManager.getCurrentPlayer()}</span>`;
                }
                
                // Update score display (only if game is running)
                if (this.isRunning && document.getElementById('scoreDisplay')) {
                    document.getElementById('scoreDisplay').textContent = this.state.score.toLocaleString();
                }
                
                if (this.isRunning) {
                    if (this.state.combo > 0) {
                        if (document.getElementById('comboDisplay')) {
                            document.getElementById('comboDisplay').textContent = 
                                `Combo: ${this.state.combo}x (${this.state.multiplier.toFixed(1)}x)`;
                        }
                    } else {
                        if (document.getElementById('comboDisplay')) {
                            document.getElementById('comboDisplay').textContent = '';
                        }
                    }
                    
                    if (document.getElementById('timerDisplay')) {
                        document.getElementById('timerDisplay').textContent = 
                            Math.ceil(this.state.timer).toString();
                    }
                }
                
                // Power-up indicator
                let powerUpText = '';
                if (this.state.powerUps.doubleScore) powerUpText += '2x Score! ';
                if (this.state.powerUps.freezeTime) powerUpText += 'Freeze! ';
                if (this.state.powerUps.clearAll) powerUpText += 'Clear All! ';
                
                let indicator = document.getElementById('powerUpIndicator');
                if (powerUpText && !indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'powerUpIndicator';
                    indicator.className = 'power-up-indicator';
                    document.querySelector('.game-container').appendChild(indicator);
                }
                if (indicator) {
                    indicator.textContent = powerUpText;
                    if (!powerUpText) indicator.remove();
                }
            }
            
            endGame() {
                this.isRunning = false;
                this.soundManager.play('stop');
                
                // Save to leaderboard with current player name
                const playerName = this.playerManager.getCurrentPlayer();
                const isHighScore = this.leaderboardManager.isHighScore(this.state.score);
                this.leaderboardManager.saveScore(this.state.score, playerName);
                
                // Update game over screen
                document.getElementById('finalScore').textContent = this.state.score.toLocaleString();
                document.getElementById('maxCombo').textContent = this.state.maxCombo;
                document.getElementById('enemiesCleared').textContent = this.state.enemiesCleared;
                
                if (isHighScore) {
                    document.getElementById('newHighScore').style.display = 'block';
                } else {
                    document.getElementById('newHighScore').style.display = 'none';
                }
                
                // Check achievements
                const achievements = this.achievementManager.checkAchievements(this.state);
                achievements.forEach(ach => {
                    this.achievementManager.showAchievement(ach);
                });
                
                // Show game over menu
                setTimeout(() => {
                    document.getElementById('gameOverMenu').classList.remove('hidden');
                    this.updateLeaderboard('gameOverLeaderboardList');
                }, 1000);
            }
            
            updateLeaderboard(listId = 'leaderboardList') {
                const leaderboard = this.leaderboardManager.loadLeaderboard();
                const listElement = document.getElementById(listId);
                
                if (leaderboard.length === 0) {
                    listElement.innerHTML = '<div style="opacity: 0.5;">No scores yet</div>';
                    return;
                }
                
                listElement.innerHTML = leaderboard.map((entry, index) => `
                    <div class="leaderboard-item">
                        <span>${index + 1}. ${entry.playerName}</span>
                        <span style="color: var(--c9-blue); font-weight: 700;">${entry.score.toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }
        
        // Initialize game when page loads
        window.addEventListener('load', () => {
            const game = new Game();
            
            // Initialize timer display with loaded duration
            document.getElementById('timerDisplay').textContent = CONFIG.GAME_DURATION.toString();
            
            // Check if player needs to be set
            if (!game.playerManager.currentPlayer) {
                setTimeout(() => {
                    game.showNameInput((name) => {
                        game.playerManager.saveCurrentPlayer(name);
                        game.updateUI();
                    });
                }, 500);
            }
        });
    </script>
</body>
</html>

